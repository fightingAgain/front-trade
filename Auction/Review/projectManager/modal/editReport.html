<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="pragma" content="no-cache">
		<!-- 禁止浏览器从本地机的缓存中调阅页面内容 -->
		<meta http-equiv="cache-control" content="no-cache, must-revalidate">
		<meta http-equiv="expires" content="0">
		<title>编辑报告</title>
		<link rel="stylesheet" href="../../../../media/js/bootstrap/css/bootstrap.css" />
	</head>
	<body>
		<script id="editor" type="text/plain" style="width:100%;height:100%;"></script>
		
		<div style="width: 100%;height: 50px;text-align:center;position: fixed;bottom: 0;background-color: #FFFFFF;z-index: 100001">
			<button type="button" id="btn_viewPdf" class="btn btn-default"><span class="glyphicon glyphicon-eye-open"></span>预览</button>
			<button type="button" id="btn_bao" class="btn btn-default"><span class="glyphicon glyphicon-ok"></span>保存</button>
			<button type="button" id="generateReport" class="btn btn-primary"><span class="glyphicon glyphicon-ok"></span>提交</button>
			<button type="button" id="btn_close" class="btn btn-default"><span class="glyphicon glyphicon-remove"></span>退出</button>
		</div>
	</body>
	<script type="text/javascript" src="../../../../media/js/jquery/jquery.js" ></script>
	<script type="text/javascript" src="../../../../media/js/jquery/jquery.ajax.js"></script>
	<script type="text/javascript" src="../../../../media/js/base/common.js" ></script>
	<script type="text/javascript" charset="utf-8" src="../../../../media/js/ueditor/ueditor.config.js"></script>
	<script type="text/javascript" charset="utf-8" src="../../../../media/js/ueditor/ueditor.all.js"> </script>
	<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
	<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
	<script type="text/javascript" charset="utf-8" src="../../../../media/js/ueditor/lang/zh-cn/zh-cn.js"></script>
	<script>
	    var url = top.config.AuctionHost;
	    var projectIds,packageIds,examTypes;
	    var thisFrame = parent.window.document.getElementById("packageclass").getElementsByTagName("iframe")[0].id;
		var dcmt = parent.$('#' + thisFrame)[0].contentWindow;
		//实例化编辑器
	    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
		var ue = UE.getEditor('editor', {
				
			fullscreen : true
		});
		var isNeedSignReport;
		function edit(projectId,packageId,examType,checkRemark,isSignReport){
			isNeedSignReport = isSignReport;
			projectIds=projectId;
			packageIds=packageId;
			examTypes=examType;
			if(checkRemark!=""&&checkRemark!=undefined&&checkRemark!=null){
				ue.ready(function() {
					ue.setContent(checkRemark, true);		
					// ue.execCommand('insertHtml', checkRemark);
				}); 				
			}else{
				$.ajax({
					type: "post",
					url: url + "/ReviewReportController/generateCheckReportHtml.do",
					async: false,
					data: {
						'projectId':projectId,
						'packageId':packageId,
						'examType': examType,						
					},
					success: function(data) {
						if(data.success){
							ue.ready(function() {
								//ue.setContent(result.data, true);		
								ue.execCommand('insertHtml', data.data);
							}); 							
						}else{
							top.layer.alert(data.message);
							parent.layer.close(parent.layer.getFrameIndex(window.name));
						}
					},
					error: function(err) {
						top.layer.alert("生成失败");
						top.layer.close(index);
					}
				});
			}
			
		}
		
		$("#btn_viewPdf").off('click').on('click',function(){
			var jData = {
					'projectId':projectIds,
					'packageId':packageIds,
					'examType': examTypes,
					'checkRemark':ue.getContent()//'<!DOCTYPE html><html>'++'</html>'
			};
			$.ajax({
				type: "post",
				url: url + "/ReviewReportController/updateCheckReport.do",
				dataType: 'json',
				data: JSON.stringify(jData),
				contentType:"application/json;charset=utf-8",
            	processData : false,
				success: function(data) {
					if(data.success){					
						var _url=$.parserUrlForToken(top.config.AuctionHost+"/ReviewReportController/previewCheckReportPdf.do?projectId="+projectIds+"&packageId="+packageIds+"&examType="+examTypes);
						parent.layer.open({
							type: 2 //此处以iframe举例
								,
							title: '预览',
							area: ['100%', '100%'],
							maxmin: true, //开启最大化最小化按钮
							content: _url,
							success: function(layero, index) {
								var iframeWind = layero.find('iframe')[0].contentWindow;	
								// iframeWind.viewPdf(projectIds,packageIds,examTypes);
							},
						});			
					}
				},
				error: function(err) {
					top.layer.alert("保存失败");					
				}
			});
			
		})
		$("#btn_bao").off('click').on('click',function(){
			var jData = {
					'projectId':projectIds,
					'packageId':packageIds,
					'examType': examTypes,
					'checkRemark':ue.getContent()//'<!DOCTYPE html><html>'++'</html>'
			};
			$.ajax({
				type: "post",
				url: url + "/ReviewReportController/updateCheckReport.do",
				dataType: 'json',
				data: JSON.stringify(jData),
				contentType:"application/json;charset=utf-8",
            	processData : false,
				success: function(data) {
					if(data.success){					
						top.layer.alert("保存成功");			
						dcmt.checkRemark=ue.getContent();
					}
				},
				error: function(err) {
					top.layer.alert("保存失败");					
				}
			});
		});
		//生成报告-评审记录汇总
		$("#generateReport").off('click').click(function() {
			var jData = {
					'projectId': projectIds,
					'packageId': packageIds,			
					'examType': examTypes,
					'checkRemark':ue.getContent(),//'<!DOCTYPE html><html>'++'</html>',
			};
			$.ajax({
				type: "post",
				url: url + "/ReviewReportController/submitCheckReport.do",
				dataType: 'json',
				data: JSON.stringify(jData),
				contentType:"application/json;charset=utf-8",
            	processData : false,
				success: function(data) {					
					if(data.success) {	
						dcmt.$('#'+dcmt._thisId).click();
						if(isNeedSignReport == 1){
							top.layer.alert("温馨提示：评标报告上传成功，请进行签章");
						}else{
							top.layer.alert("生成成功");
						}
						parent.layer.close(parent.layer.getFrameIndex(window.name));
					} else {
						if(data.message){
							top.layer.alert(data.message);
						}else{
							top.layer.alert("生成失败");
						}
					}
				},
				error: function(err) {
					top.layer.alert("生成失败");					
				}
			});
		});
		$("#btn_close").off('click').on('click',function(){
			parent.layer.close(parent.layer.getFrameIndex(window.name));
		})		
	</script>
</html>
