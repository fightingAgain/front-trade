<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" type="text/css" href="../../../../media/js/layer/mobile/need/layer.css" />
	<link rel="stylesheet" type="text/css" href="../../../../media/js/layer/css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../../../../media/js/bootstrap/css/bootstrap.css" />
	<!-- <link rel="stylesheet" type="text/css" href="../../../media/js/bootstrap/css/bootstrap-table.css"> -->
	<style>
		.layui-table th{
			font-weight: 600;
		}
		table{
			margin-bottom: 0px !important;
		}
		.layui-input{
			height: 28px !important;
		}
	</style>
</head>

<body>
	<div style="margin-bottom: 60px;padding: 5px;">
		<table class="table table-bordered" id="mainTable"></table>
	</div>

	<div class="bottom-btn">
		<button type="button" class="btn btn-primary" id="btnSubmit">提交</button>
	</div>
</body>
<script type="text/javascript" src="../../../../media/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../../../../media/js/jquery/jquery.ajax.js"></script>
<script type="text/javascript" src="../../../../media/js/base/common.js"></script>
<script type="text/javascript" src="../../../../media/js/layer/layer.js"></script>
<script type="text/javascript" src="../../../../media/js/layer/layui.js"></script>
<script type="text/javascript" src="../../../../media/js/base/util.js"></script>
<script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap-table.min.js"></script>
<script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap-table-zh-CN.min.js"></script>
<script>
	var expertId = getUrlParam("expertIds");//标段Id
	var packageCheckListId = getUrlParam("packageCheckListId");//评标id
	var examType = getUrlParam("examType");
	var projectId = getUrlParam("projectId");
	var checkUrl = top.config.AuctionHost + '/CheckConfirmController/getObjectData.do';//评委获取 客观项打分数据
	var saveUrl = top.config.AuctionHost + '/CheckConfirmController/submitUpdateReason';//确认
	var checkType = '';//0合格制  1偏离制 2响应制 3打分制
	var checkData = [], colsData = [], packageId, checkName, bidCheckItems, scoreList;
	var height = document.documentElement.clientHeight - 95;
	//关闭
	$("#btnClose").click(function () {
		var index = top.layer.getFrameIndex(window.name);
		top.layer.close(index);
	});
	$.ajax({
		type: "post",
		url: checkUrl,
		async: false,
		data: {
			'expertId': expertId,//评委id
			'packageCheckListId': packageCheckListId,//评审项id
			'examType': examType,//资格审查方式 0预审 1后审
		},
		success: function (res) {
			var colsData1 = [
				{title: '序号', type:'numbers', fixed: 'left', rowspan: '2'},
				{field:'checkTitle',  title: '评价内容', fixed: 'left',width:'300', rowspan: '2'},
				{field:'checkStandard',  title: '评审标准', fixed: 'left',width:'300', rowspan: '2'}
			], colsData2 = [];//二维数组
			var colspan = '1';//投标人合并列数（评委数量）
			if (res.success) {
				if(res.data){
					
					packageId = res.data.packageId;
					if(res.data.confirmButnStatus && res.data.confirmButnStatus == 1){
						$('#btnGoOn').show();
					}
					if(res.data.updateReasonButnStatus && res.data.updateReasonButnStatus == 1){
						$('#btnReason').show();
					}
					if(res.data.packageCheckList){
						checkName = res.data.packageCheckList.checkName;
						checkType = res.data.packageCheckList.checkType;
					}
					if(res.data.experts){
						colspan = res.data.experts.length;
					}
					if(res.data.offers){
						var suppliers = res.data.offers;//投标人
						var experts = res.data.experts;//评委
						scoreList = res.data.checkItemInfos;//打分
						bidCheckItems = res.data.packageCheckItems;//评审内容
						//循环供应商
						for(var i = 0;i<suppliers.length;i++){
							//处理一维数组
							var obj = {title: suppliers[i].enterpriseName ,align:'center', colspan: '2'};
							colsData1.push(obj);
							//循环评委
							// for(var e=0;e<experts.length;e++){
								let fId = suppliers[i].supplierId + '_score';
								let reason = suppliers[i].supplierId;
								//处理二维数组
								let objExperts = {field: fId, title: '结果',width:'100',align:'center'};
								let objScore = {field: reason, title: '原因',width:'200',align:'center', templet: function(val, a, c){
									//标记  0为正常 1为标红  2为标绿
									if(val[reason].scoreTypeFlag == 1){
										if(val[reason] && val[reason].reason){
											return '<input class="layui-input reason" data-id="'+val[reason].infoId+'" maxlength="200" value="'+val[reason].reason+'" />'
										}else{
											return '<input class="layui-input reason" data-id="'+val[reason].infoId+'" maxlength="200" />'
										}
									}else{
										return val[reason].reason?val[reason].reason:''
									}
									
								}};
								colsData2.push(objExperts);
								colsData2.push(objScore);
							// }
						}
								
						// 循环评审内容
						for(var b=0;b<bidCheckItems.length;b++){
							//处理打分
							for(var s=0;s<scoreList.length;s++){
								if(bidCheckItems[b].id == scoreList[s].id){
									var fId = scoreList[s].supplierId + '_score';
									var reason = scoreList[s].supplierId;
									//scoreTypeFlag 标记  0为正常 1为标红  2为标绿
									bidCheckItems[b][fId] = scoreList[s].itemScore;
									bidCheckItems[b][reason] = {'reason': (scoreList[s].scoreReason?scoreList[s].scoreReason:''), 'infoId': scoreList[s].infoId, 'scoreTypeFlag': scoreList[s].scoreTypeFlag};
								}
							}
						}
			
					}
					colsData = [colsData1, colsData2];
					console.log(colsData)
					console.log(bidCheckItems)
					tableHtml(colsData, bidCheckItems);
				}
				
				
			} else {
				top.layer.alert(res.message);
			}
		}
	});
	var checkData = [
		{'bidderName': '111', 'fileSubmitTime':'qq', 'signDate': 'ooo', 'signInDate': 'ppp','sign':'000', 'signIn':'ppp'},
		{'bidderName': '222', 'fileSubmitTime':'aa', 'signDate': 'ddd', 'signInDate': 'fff','sign':'ggg', 'signIn':'hhh'},
	];
	function tableHtml(cols, data){
		layui.use('table', function(){
			var table = layui.table;
			  
			var tableIns =  table.render({
				elem: '#mainTable'
				,limit: Number.MAX_VALUE // 数据表格默认全部显示
		//		    ,url:'/demo/table/user/'
		//		    ,width: 892
			,height: height
			,cols: cols
				// ,cols: [[
				// 	{title: '序号', type:'numbers', fixed: 'left', rowspan: '2'}
				// 	,{field:'bidderName',  title: '投标单位名', fixed: 'left',width:'300', rowspan: '2'}
				// 	,{title: '供应商1',align:'center', colspan:'2'}
				// 	,{title: '供应商2',align:'center', colspan:'2'}
				// 	,{field:'fileSubmitTime',  title: '投标',width:'300', rowspan: '2'}
				// ],[
				// 	{field:'signDate', title: '评委1',width:'200',align:'center'},
				// 	{field:'signInDate', title: '评委2',width:'200',align:'center'},
				// 	{field:'sign', title: '评委1',width:'200',align:'center'},
				// 	{field:'signIn', title: '评委2',width:'200',align:'center'}
				// ]]
			,data:data
			});
		  
		});
	};
	function passMessage(callback){
		$('#btnSubmit').click(function(){
			selectResults(callback)
		});
	};
	function selectResults(callback){
		var data = {
			'expertId': expertId,//评委id
			'packageCheckListId': packageCheckListId,//评审项id
			'examType': examType,//资格审查方式 0预审 1后审
		};
		var reasons = $('.reason');
		var isPass = true;
		for(var b=0;b<reasons.length;b++){
			var reasonId = reasons.eq(b).attr('data-id')
			for(var s=0;s<scoreList.length;s++){
				if(reasonId == scoreList[s].infoId){
					if($.trim($('.reason').eq(b).val()) != ''){
						scoreList[s].scoreReason = $.trim($('.reason').eq(b).val());
					}else{
						isPass = false
					}
				}
			}
		}
		if(!isPass){
			top.layer.alert('温馨提示：还有原因未填，请检查');
			return
		}
		data.checkItemInfos = scoreList;
		$.ajax({
			type: "post",
			url: saveUrl,
			async: false,
			contentType:"application/json;charset=utf-8",//解决数据量大时后台接收不到，后台对应用字符串方式接收
			data: JSON.stringify(data),//解决数据量大时后台接收不到，后台对应用字符串方式接收
			// dataType: 'json',
			// data: data,
			success: function (res) {
				if (res.success) {
					if(callback){
						callback();
					};
					var index = top.layer.getFrameIndex(window.name);
					top.layer.close(index);
				}else{
					top.layer.alert(res.message)
				}
			}
		});
	}
	
</script>

</html>