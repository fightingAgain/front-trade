<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="pragma" content="no-cache">
	<!-- 禁止浏览器从本地机的缓存中调阅页面内容 -->
	<meta http-equiv="cache-control" content="no-cache, must-revalidate">
	<meta http-equiv="expires" content="0">
	<title>谈判方式</title>
	<link rel="stylesheet" href="../../../../media/js/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" href="../../../../media/js/bootstrap/css/bootstrap-table.css">
</head>

<body>
	<table class="table table-bordered " style="margin: 2px;width: 99%;height: 99%;margin-bottom: 60px">
		<tr>
			<td class="th_bg">选择谈判方式</td>
			<td><label style="color: red;">温馨提示:线上谈判,线下谈判,不谈判只能选择其一</label></button>
			</td>
		</tr>
		<tr>
			<td class="th_bg">谈判方式</td>
			<td>
				<input type="radio" name="negotiator" value="0" checked="checked" />线上谈判
				<input type="radio" name="negotiator" value="1" />线下谈判
				<input type="radio" name="negotiator" value="2" />不谈判
			</td>
		</tr>

	</table>
	<div
		style="width: 100%;height: 50px;text-align:center;position: fixed;bottom: 0;background-color: #FFFFFF;z-index: 100001">
		<button type="button" id="btn_submit" class="btn btn-primary"><span
				class="glyphicon glyphicon-saved"></span>下一步</button>
		<button type="button" id="btn_close" class="btn btn-default"><span
				class="glyphicon glyphicon-remove"></span>关闭</button>
	</div>
</body>
<script type="text/javascript" src="../../../../media/js/jquery/jquery.min.js"></script>
<script src="../../../../media/js/jquery/jquery.extend.js"></script>

<script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap-table.min.js"></script>
<script src="../../../../media/js/bootstrap/js/bootstrap-table-zh-CN.min.js"></script>
<script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="../../../../media/js/layer/layer.js"></script>
<script type="text/javascript">
	var saveNegotiatorItem = parent.config.AuctionHost + "/NegotiationController/saveNegotiationItem";
	var findNegotiatorUrl = parent.config.AuctionHost + '/NegotiationController/pageNegotiationForPurchaser';
	var projectId = getUrlParam('projectId');
	var packageId = getUrlParam('id');
	var tenderTypeCode = 1;//竞价采购
	var items; //项目包件信息
	var negotiation;
	var value;

	var detailedId = "";
	var auctionModel = "";

	var reloadTab = 0;

	function getMessage(obj) {
		value = '0';

		items = obj;

		if (obj.auctionModel != undefined) {
			auctionModel = obj.auctionModel;
		}

		if (obj.detailedId != undefined) {
			detailedId = obj.detailedId;
		}

		source();
	}
	$(function () {
		//关闭按钮
		$("#btn_close").click(function () {
			parent.layer.close(parent.layer.getFrameIndex(window.name));
		});
		//下一步
		$("#btn_submit").click(function () {
			add()
		});
	})
	function source() {
		$('input[name="negotiator"]').change(function () {
			value = $('input[name="negotiator"]:checked').val();
			items.negotiationType = value;
			negotiation = {
				'negotiationType': value,
				'projectId': projectId,
				'packageId': packageId,
				'tenderType': tenderTypeCode,//竟低价采购
				'auctionModel': auctionModel,
				'detailedId': detailedId,
				'packageDetailedId': detailedId,
			}
		});

		negotiation = {
			'negotiationType': value,
			'projectId': projectId,
			'packageId': packageId,
			'tenderType': tenderTypeCode,//竟低价采购
			'auctionModel': auctionModel,
			'detailedId': detailedId,
			'packageDetailedId': detailedId,
		}
		items.negotiationType = value;
	}
	//添加谈判
	function add() {

		//谈判类型  0为线上谈判，1为线下谈判，2为不谈判
		if (negotiation.negotiationType == '0') {
			///parent.layer.close($index);
			parent.layer.open({
				type: 2 //此处以iframe举例
				, title: '添加线上谈判'
				, area: ['1000px', '600px']
				, content: 'Auction/Auction/Purchase/PucharesSupplierNegotiator/addNegotiator.html?projectId=' + projectId + '&id=' + packageId
				//,btn: ['提交','取消'] 
				, id: "addNegotiator"
				//确定按钮
				, success: function (layero, index) {
					var iframeWinS = layero.find('iframe')[0].contentWindow;
					var data = {
						auctionModel: auctionModel,
						detailedId: detailedId,
					}
					iframeWinS.show(data);
					parent.layer.close(parent.layer.getFrameIndex(window.name));
				}
			});
		}

		if (negotiation.negotiationType == '1') {
			//线下谈判 
			parent.layer.open({
				type: 2,//此处以iframe举例
				title: '添加线下谈判',
				area: ['1000px', '600px'],
				id: "negotiators",
				content: 'Auction/Auction/Purchase/PucharesSupplierNegotiator/underline.html?projectId=' + projectId + '&id=' + packageId,
				success: function (layero, index) {
					var iframeWin = layero.find('iframe')[0].contentWindow;
					iframeWin.getShow(items);
					parent.layer.close(parent.layer.getFrameIndex(window.name));
				}
			});
		}

		if (negotiation.negotiationType == '2') {
			//不谈判 
			$.ajax({
				url: saveNegotiatorItem,
				type: 'post',
				dataType: 'json',
				data: negotiation,
				success: function (data) {
					if (data.success) {
						if (auctionModel == 1) {//按明细

							parent.layer.alert("设置成功!");
							if (reloadTab == 1) {
								preCallBack();//刷新
							}

						} else {//按包件
							parent.$('#PucharesNegotiator').bootstrapTable('refresh', { url: findNegotiatorUrl });
							parent.layer.alert("设置成功!");
						}
					} else {
						top.layer.alert(data.message);
						// parent.layer.alert("设置失败!");
					}
				}
			})
			parent.layer.close(parent.layer.getFrameIndex(window.name));
		}

		// if (!(auctionModel != "" && auctionModel == 1)) {
		//按包件
		// parent.layer.close(parent.layer.getFrameIndex(window.name));
		// }
	}


	//刷新父页面
	function reloadConsole(callback) {
		reloadTab = 1;
		preCallBack = callback;
	}

	function getUrlParam(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); // 构造一个含有目标参数的正则表达式对象  
		var r = window.location.search.substr(1).match(reg); // 匹配目标参数  
		if (r != null) return unescape(r[2]);
		return null; // 返回参数值  
	}

</script>

</html>