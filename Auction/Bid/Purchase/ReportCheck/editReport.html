<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="pragma" content="no-cache">
		<!-- 禁止浏览器从本地机的缓存中调阅页面内容 -->
		<meta http-equiv="cache-control" content="no-cache, must-revalidate">
		<meta http-equiv="expires" content="0">
		<title>编辑报告</title>
		<link rel="stylesheet" href="../../../../media/js/bootstrap/css/bootstrap.css" />
	</head>
	<body>
		<script id="editor" type="text/plain" style="width:100%;height:400px;"></script>
		<div style="width: 100%;height: 50px;text-align:center;position: fixed;bottom: 0;background-color: #FFFFFF;z-index: 100001">
			<button type="button" id="btn_bao" class="btn btn-default" style="width: 100px;">保存</button>
			<button type="button" id="generateReport" class="btn btn-primary" style="width: 100px;">提交</button>
			<button type="button" id="btn_close" class="btn btn-default" style="width: 100px;">退出</button>
		</div>
	</body>
	<script type="text/javascript" src="../../../../media/js/jquery/jquery.js" ></script>
	<script type="text/javascript" src="../../../../media/js/jquery/jquery.extend.js"></script>
	<script type="text/javascript" src="../../../../media/js/base/common.js" ></script>
	<script type="text/javascript" charset="utf-8" src="../../../../media/js/ueditor/ueditor.config.js"></script>
	<script type="text/javascript" charset="utf-8" src="../../../../media/js/ueditor/ueditor.all.js"> </script>
	<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
	<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
	<script type="text/javascript" charset="utf-8" src="../../../../media/js/ueditor/lang/zh-cn/zh-cn.js"></script>
	<script>
	    var url = top.config.bidhost;
	    var projectIds,packageIds,examTypes;
	    var thisFrame = parent.window.document.getElementById("packageclass").getElementsByTagName("iframe")[0].id;
		var dcmt = parent.$('#' + thisFrame)[0].contentWindow;
		//实例化编辑器
	    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
	    var ue = UE.getEditor('editor');
		function edit(projectId,packageId,examType,checkRemark){
			projectIds=projectId;
			packageIds=packageId;
			examTypes=examType;
			if(checkRemark!=""&&checkRemark!=undefined&&checkRemark!=null){
				ue.ready(function() {
					//ue.setContent(result.data, true);		
					ue.execCommand('insertHtml', checkRemark);
				}); 				
			}else{
				$.ajax({
					type: "post",
					url: url + "/WaitCheckProjectController/produceProjectCheckResult.do",
					async: false,
					data: {
						'projectId':projectId,
						'packageId':packageId,
						'examType': examType,
						itemState: "0"
					},
					success: function(data) {
						if(data.success){
							ue.ready(function() {
								//ue.setContent(result.data, true);		
								ue.execCommand('insertHtml', data.data);
							}); 							
						}
					},
					error: function(err) {
						top.layer.alert("生成失败");
						top.layer.close(index);
					}
				});
			}
			
		}
		$("#btn_bao").on('click',function(){
			var jData = {
					'projectId':projectIds,
					'packageId':packageIds,
					'examType': examTypes,
					'checkRemark':ue.getContent(),
					'itemState': "0"
			};
			$.ajax({
				type: "post",
				url: url + "/WaitCheckProjectController/updateCheckReport.do",
				dataType: 'json',
				data: JSON.stringify(jData),
				contentType:"application/json;charset=utf-8",
            	processData : false,
				success: function(data) {
					if(data.success){					
						top.layer.alert("保存成功");			
						dcmt.checkRemark=ue.getContent();
					}
				},
				error: function(err) {
					top.layer.alert("保存失败");					
				}
			});
		});
		//生成报告-评审记录汇总
		$("#generateReport").click(function() {
			var jData = {
					'projectId': projectIds,
					'packageId': packageIds,			
					'examType': examTypes,
					'checkRemark':ue.getContent(),
					'itemState': "0"
			};
			$.ajax({
				type: "post",
				url: url + "/WaitCheckProjectController/produceProjectCheckResultPdf.do",
				dataType: 'json',
				data: JSON.stringify(jData),
				contentType:"application/json;charset=utf-8",
            	processData : false,
				success: function(data) {					
					if(data.success) {
//						parent.$("#generateReport").attr("disabled", true);
//						parent.$("#generateReport").css("pointer-events", "none");
						dcmt.$("#editReport").attr("disabled", true);
						dcmt.$("#editReport").css("pointer-events", "none");	
						dcmt.PriceCheckTotal(dcmt.packageData)
						top.layer.alert("生成成功");
						parent.layer.close(parent.layer.getFrameIndex(window.name));
					} else {
						if(data.message){
							top.layer.alert(data.message);
						}else{
							top.layer.alert("生成失败");
						}
					}
				},
				error: function(err) {
					top.layer.alert("生成失败");					
				}
			});
		});
		$("#btn_close").on('click',function(){
			parent.layer.close(parent.layer.getFrameIndex(window.name));
		})		
	</script>
</html>
