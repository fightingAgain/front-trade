<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="pragma" content="no-cache">
		<!-- 禁止浏览器从本地机的缓存中调阅页面内容 -->
		<meta http-equiv="cache-control" content="no-cache, must-revalidate">
		<meta http-equiv="expires" content="0">
		<title>报名</title>
		<link rel="stylesheet" type="text/css" href="../../../../media/js/bootstrap/css/bootstrap.css" />
		<style>
	    
	         .table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td{
			 	vertical-align: middle;
			 }
	    </style>
	</head>
	<body>
		<div style="padding-bottom: 55px;">
			<table  class="table table-bordered" style="margin-bottom: 0px;width: 99%;margin-left: 5px;">
				<tr>
					<td style="text-align: center;">
						<font color="red" size="4"><span class='timeShow'>距</span>报名截止时间</font>
					</td>
					<td rowspan="2" colspan="3"><font color="red" >温馨提示：
						 <div>(1)必须在报名截止时间前进行报名，逾期视为网上报名无效。</div>	</font>
					</td> 
				 </tr>
				 <tr>
					<td style="text-align: center;">
						<font color="red" size="4">
							<div id="signEndDate"></div>
						</font>
					</td>
				 </tr>
				 <tr>
					<td colspan="4" style="font-weight: bold;" class="active">基本信息</td>
				 </tr>
				 <tr>
					<td class="th_bg" style="width: 20%;">采购项目名称</td>
					<td style="text-align: left;width: 30%;" ><div id="projectName"></div></td>
					<td class="th_bg" style="width: 20%;">项目编号</td>
					<td style="text-align: left;"><div id="projectCode"></div></td>  
				 </tr>
				 <tr>
					<td class="th_bg" style="width: 20%;">包件名称</td>
					<td style="text-align: left;"><div id="packageName"></div></td>
					<td class="th_bg" style="width: 20%;">包件编号</td>
					<td style="text-align: left;"><div id="packageNum"></div></td>            
				 </tr>
				 <tr>
					<td colspan="4" style="font-weight: bold;" class="active">录入报名单位</td>
				 </tr>
				 <tr>
					<td class="th_bg">报名单位</td>
					<td style="text-align: left;" colspan="3"><div id="enterpriseName"></div></td>

				 </tr>
				 <tr>
					<td class="th_bg">联系人<i class="red">*</i></td>
					<td style="text-align: left;"><input type="text"  id="linkMen" name="linkMen" class="form-control layui-input link" /></td>
					<td class="th_bg">联系手机<i class="red">*</i></td>
					<td style="text-align: left;"><input type="text"  id="linkTel" name="linkTel"  class="form-control layui-input link" /></td>            
				 </tr>
				 <tr>
					<td class="th_bg">联系邮箱<i class="red">*</i></td>
					<td style="text-align: left;" ><input type="text"  id="linkEmail" name="linkEmail" class="form-control layui-input link"></td>
					<td style="text-align: left;" class="red" colspan="2"><font color="red" style="font-weight: bold;" class="redTitle">温馨提示：填写完信息且支付完成后才算报名成功</font></td>
				 </tr>
				 <tr>
					<td colspan="3" style="font-weight: bold;border-right: 0px;" class="active">报名信息</td>
					<td style="text-align: right;width:150px;border-left: 0px;padding-right: 15px;" class="active">
						<button id="btnAdd" type="button" class="btn btn-sm btn-primary">
							 <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> 确认报名
					   </button>
					</td>
				 </tr>
				 <tr>
					<td class="th_bg">确认报名</td>
					<td colspan="3" style="text-align: left;"><div id="userName"/></div></td>	           
					
				 </tr>
				 <tr>
					<td class="th_bg">确认时间</td>
					<td style="text-align: left;"><div id="subDate"/></div></td>    
					<td class="th_bg">报名单号</td>
					<td style="text-align: left;"><div id="signCode"/></div></td>
				 </tr>
				<!-- <tr>
					<td colspan="4" style="font-weight: bold;" >温馨提示：在报名截止时间前完成此步,逾期视为报名无效</td>
				 </tr>-->
				 <tr>
					<td colspan="4" style="font-weight: bold;" class="active">报名回执单</td>
				 </tr>
				 <tr>
					<td class="th_bg">报名回执单</td>
					<td style="text-align: left;" colspan="3">
						<!--<button id="btnShow" type="button" class="btn btn-sm btn-primary">
							 <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> 回执
					   </button>-->
					   <button id="btnShowFile" type="button"  class="btn btn-sm btn-primary receipt">
							 <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> 预览
					   </button>
						<button id="btnDownLoad" type="button" class="btn btn-sm btn-primary receipt">
							 <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span> 下载
					   </button>
					</td>
		
				 </tr>
			 </table>
			<div class="bottom-btn" style="z-index: 11000;">
				<button type="button" class="btn btn-default" id="btn_close"><span class="glyphicon glyphicon-remove"></span>关闭</button>
			</div>
		 </div>
	</body>
	<script type="text/javascript" src="../../../../media/js/jquery/jquery.min.js"></script>
	<script src="../../../../media/js/jquery/jquery.extend.js"></script>
	<script src="../../../../media/js/base/util.js"></script>
	<script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap-table.min.js"></script>
	<script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap.js"></script>
	<script type="text/javascript" src="../../../../media/js/base/util.js"></script>
	<script type="text/javascript" src="../../../../media/js/base/common.js"></script>
	<script type="text/javascript" src="../../../../media/js/base/Pay.js"></script>
	<script type="text/javascript" src="../../../../Order/Pay/js/payment.js"></script>
	<script type="text/javascript" src="../../../../media/js/base/newPay.js"></script>
	<script src="../../../../media/js/layer/layer.js"></script>
</html>

<script>
	var loadFile = top.config.bidhost + "/FileController/download.do"; //文件下载
	var packageId = getUrlParam("packageId");
	var examType = getUrlParam("examType");
	var projectId = getUrlParam("projectId");
	var supplierDate;
	if(parent.isSetB="NO"){
		$(".redTitle").hide()
	};	
	$(function(){
		$('#btn_close').click(function(){
			var index = parent.layer.getFrameIndex(window.name);
			top.layer.close(index);
		});
		//查询用户报名信息
		getSupplierSign();
		
	})
	var systemTime;
	function getSupplierSign(){
		
		$.ajax({
			type: "get",
			url: top.config.Syshost + "/EmployeeController/logOurView.do",
			async: false,
			success: function(data) {
				if(data.success) {
					data = data.data;
					if(data) {
						
						systemTime = data.currentTime;
						
						setInterval(function() {
							systemTime += 1000;
							//$("#systemTime").html(formatUnixtimestamp(systemTime));
						}, 1000);

					}
				}
	
			}
		});
		
		$.ajax({
			type: "post",
			url: top.config.bidhost + "/PurchaseController/findSupplierSignInfo.do",
			data: {
				packageId: packageId,
			},
			async: true,
			success: function(data) {
				if(data.success){
					
					supplierDate = data.data;
					
					$('div').each(function() {
						//判断谈判方式
						$(this).text(supplierDate[this.id]);
					});
					
					if(supplierDate.userName){
						$("#linkMen").val(supplierDate.linkMen);
						$("#linkTel").val(supplierDate.linkTel);
						
						$("#linkEmail").val(supplierDate.linkEmail);
						
						$(".link").attr("readonly",true);
						
						$("#btnAdd").hide()
						$(".redTitle").hide()
						
						
					}
					
					if(supplierDate.filePath){
						$("#btnShow").hide();
						$(".receipt").show();
					}
					
					go(GetTime(supplierDate.signEndDate));
				}else{
					
				}
			}
		});
		
	}
	
	function GetTime(time){
		var date=new Date(time.replace("-", "/").replace("-", "/")).getTime()
		return date;
	};
	
	
	var fapiao = /^(0[0-9][0-9][0-9]|0[0-9][0-9]|1[3-9][0-9])\d{8}$/; //手机,座机
	var email = /^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/; //邮箱
	//确认报名
	$("#btnAdd").click(function(){
		var nowSysDate=top.$("#systemTime").html()+" "+top.$("#sysTime").html();//当前系统时间
		if( GetTime(nowSysDate) > GetTime(supplierDate.signEndDate)){
			parent.layer.alert("温馨提示：感谢参与该项目的采购，报名已结束，请继续关注其它项目，谢谢！");
			return false;
		};						
		if($("#signCode").text() != ""){
			parent.layer.alert("温馨提示：您已报名成功,请勿重复操作！");
			return false;
		}
		
		if($("#linkMen").val() == ""){
			parent.layer.alert("温馨提示：请输入联系人");
			return false;
		}
		if($("#linkMen").val().length > 10){
			parent.layer.alert("温馨提示：联系人长度不能超过10个字");
			return false;
		}
		
		if($("#linkTel").val() == ""){
			parent.layer.alert("温馨提示：请输入联系电话！");
			return false;
		}
		if($("#linkTel").val().length > 12){
			parent.layer.alert("温馨提示：联系电话长度不能超过12位！");
			return false;
		}
		
		if(!fapiao.test($("#linkTel").val())) {
			parent.layer.alert("温馨提示：联系电话格式不正确！");
			return false;
		}
		
		if($("#linkEmail").val() == ""){
			parent.layer.alert("温馨提示：请输入联系邮箱！");
			return false;
		}
		
		if($("#linkEmail").val().length > 100){
			parent.layer.alert("温馨提示：联系邮箱长度不能超过100个字符");
			return false;
		}
		
		if(!email.test($("#linkEmail").val())) {
			parent.layer.alert("温馨提示：联系邮箱格式不正确！");
			return false;
		}
		
		$.ajax({
			type: "post",
			url: top.config.bidhost + "/PurchaseController/findSupplierSign.do",
			data: {
				projectId: projectId,
				packageId: packageId,
				linkMen:$("#linkMen").val() ,
				linkEmail:$("#linkEmail").val() ,
				linkTel:$("#linkTel").val()
			},
			async: true,
			success: function(data) {
				if(data.success){
					//判断用户是否缴纳报名费
					if(supplierDate.status == 0&&supplierDate.price!==0&&supplierDate.price!==undefined){			
						isOrder();
					};					
					getSupplierSign();
					top.$('#table').bootstrapTable(('refresh'));
					//top.layer.closeAll();					
				}else{
					//top.layer.closeAll();
					if(data.message){
						top.layer.alert(data.message);
					}else{
						top.layer.alert("报名失败");
					}
				}
			}
		});
	})
function isOrder(){
	if(examType==0){
		var title=findServiceCharges()=="YES"?"支付报名费后，需缴纳平台服务费（<a href='"+ platformFeeNoticeUrl +"' target ='_blank'>点击这里查看平台服务费收费标准</a>）才能递交资格申请文件。确认要支付报名费吗？":"确认要支付报名费?"
	}else{
		var title=findServiceCharges()=="YES"?"支付报名费后，需缴纳平台服务费（<a href='"+ platformFeeNoticeUrl +"' target ='_blank'>点击这里查看平台服务费收费标准</a>）才能报价。确认要支付报名费吗？":"确认要支付报名费?"
	}
	top.layer.confirm(title, function(indexsmm) {
		//生成订单
		$.ajax({
			type: "post",
			url: top.config.bidhost + "/OrderController/isPayOrderInfo.do",
			data: {
				projectId: projectId,
				packId: packageId,
				prefixOrder:orderSoruc.sys,
				moneyType:'报名费',
			},
			async: false,
			success: function(data) {
				if(!data.success) {				
					//pay(data.message,'Ordertable')	
					
					payMoney(packageId,data.message,'table');
					parent.layer.close(indexsmm)
					//getGoodsList({enterpriseId:'52475736447e4be0a15c201c148b47d0', packageId}, payGoodsCallback);
					//openGoodsPage(packageId,'',data.message,'Ordertable');
				}
			}  
		})
	});			
}
function findServiceCharges(){
	var isSetServiceCharges="";
	$.ajax({
			type: "post",
			url: config.Syshost+'/EnterpriseChargesController/findServiceCharges.do',
			datatype: 'json',
			data:{
				'packageId':packageId
			},
			async: false,
			success: function(data) {
				if(data.success) {
					for(var i=0;i<data.data.length;i++){
						if(data.data[i].optionName=="平台服务费"){
							isSetServiceCharges=data.data[i].optionText;														
						}						
						
					}				
				}
				
		}
   })
   return isSetServiceCharges	
}
	//打印回执
	$("#btnShow").click(function(){
		//判断是否确认报名
		if($("#signCode").text() == ""){
			parent.layer.alert("温馨提示：您还未进行报名，请点击确认报名按钮完成报名！");
			return false;
		}
		var nowSysDate=top.$("#systemTime").html()+" "+top.$("#sysTime").html();//当前系统时间
		if(typeof(supplierDate.filePath) == "undefined" && GetTime(nowSysDate) > GetTime(supplierDate.signEndDate)){
			parent.layer.alert("温馨提示：报名已结束,您尚未报名！");
			return false;
		}
		
		$.ajax({
			type: "post",
			url: top.config.bidhost + "/BidFileController/addBidReceipt.do",
			data: {
				projectId: projectId,
				packageId: packageId,
				receiptType:0,//报名回执单
			},
			async: true,
			success: function(data) {
				if(data.success){
					
					getSupplierSign();
					
					
					//top.$('#table').bootstrapTable(('refresh'));
					//top.layer.closeAll();
					top.layer.alert("生成回执成功");
				}else{
					//top.layer.closeAll();
					if(data.message){
						top.layer.alert(data.message);
					}else{
						top.layer.alert("生成回执单失败");
					}
				}
			}
		});
	})
	//预览
	$("#btnShowFile").click(function(){
		if($("#signCode").text() == ""){
			parent.layer.alert("温馨提示：您还未进行报名，请点击确认报名按钮完成报名！");
			return false;
		}
		var nowSysDate=top.$("#systemTime").html()+" "+top.$("#sysTime").html();//当前系统时间
		if(typeof(supplierDate.filePath) == "undefined" &&  GetTime(nowSysDate)> GetTime(supplierDate.signEndDate)){
			parent.layer.alert("温馨提示：报名已结束,您尚未报名！");
			return false;
		}
		
		//window.open($.parserUrlForToken(top.config.bidhost + "/FileController/fileView.do?ftpPath=" + supplierDate.filePath));
		previewPdf(supplierDate.filePath);
	})

	//下载
	$("#btnDownLoad").click(function(){
		if($("#signCode").text() == ""){
			parent.layer.alert("温馨提示：您还未进行报名，请点击确认报名按钮完成报名！");
			return false;
		}
		var nowSysDate=top.$("#systemTime").html()+" "+top.$("#sysTime").html();//当前系统时间
		if(typeof(supplierDate.filePath) == "undefined" && (nowSysDate) > GetTime(supplierDate.signEndDate)){
			parent.layer.alert("温馨提示：报名已结束,您尚未报名！");
			return false;
		}
		
		var newUrl = loadFile + "?ftpPath=" + supplierDate.filePath +"&fname="+"报名回执单.pdf";
		window.location.href = $.parserUrlForToken(newUrl);
		
	})
	
	 var _ordertimer;
	 //var data=new Date();
	 //document.getElementById("date2").value=data.getFullYear()+'-'+(data.getMonth()+1)+'-'+data.getDate()+' '+data.getHours()+':'+data.getMinutes()+':'+data.getSeconds();//当前时间
	 function leftTimer(enddate) {
		 //var leftTime = (new Date(enddate)) - new Date(); //计算剩余的毫秒数
		var systemTime=top.$("#systemTime").html()+" "+top.$("#sysTime").html();//当前系统时间
		leftTime = enddate - GetTime(systemTime);

		
		  var days = parseInt(leftTime / 1000 / 60 / 60 / 24, 10); //计算剩余的天数
		  var hours = parseInt(leftTime / 1000 / 60 / 60 % 24, 10); //计算剩余的小时
		  var minutes = parseInt(leftTime / 1000 / 60 % 60, 10);//计算剩余的分钟
		  var seconds = parseInt(leftTime / 1000 % 60, 10);//计算剩余的秒数
		  days = checkTime(days);
		  hours = checkTime(hours);
		  minutes = checkTime(minutes);
		  seconds = checkTime(seconds);
		  if (days >= 0 || hours >= 0 || minutes >= 0 || seconds >= 0) document.getElementById("signEndDate").innerHTML = days + "天" + hours + "小时" + minutes + "分" + seconds + "秒";
		  if (days <= 0 && hours <= 0 && minutes <= 0 && seconds <= 0) {
			  clearInterval(_ordertimer);
				$(".timeShow").hide();
				$("#signEndDate").text(supplierDate.signEndDate);
		  }
	 }
	 function checkTime(i) { //将0-9的数字前面加上0，例1变为01
		  if (i < 10) {
		  i = "0" + i;
		  }
		  return i;
	 }
	 function go(data2){
		var systemTime=top.$("#systemTime").html()+" "+top.$("#sysTime").html();//当前系统时间
		 //var date1=new Date(),data2=new Date(v);
		 if(data2<=GetTime(systemTime)){
		  	$(".timeShow").hide();
		  	$("#signEndDate").text(supplierDate.signEndDate);
		    return false;
		 }//设置的时间小于现在时间退出
		 _ordertimer = setInterval(function(){
			
			leftTimer(data2)
			
		 }, 1000);
	 }
	
	function getUrlParam(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); // 构造一个含有目标参数的正则表达式对象  
		var r = window.location.search.substr(1).match(reg); // 匹配目标参数  
		if(r != null) return unescape(r[2]);
		return null; // 返回参数值  
	}
	
	
	function formatUnixtimestamp(inputTime) {

		var date = new Date(inputTime);
		var y = date.getFullYear();
		var m = date.getMonth() + 1;
		m = m < 10 ? ('0' + m) : m;
		var d = date.getDate();
		d = d < 10 ? ('0' + d) : d;
		var h = date.getHours();
		h = h < 10 ? ('0' + h) : h;
		var minute = date.getMinutes();
		var second = date.getSeconds();
		minute = minute < 10 ? ('0' + minute) : minute;
		second = second < 10 ? ('0' + second) : second;
		return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;
	};
</script>