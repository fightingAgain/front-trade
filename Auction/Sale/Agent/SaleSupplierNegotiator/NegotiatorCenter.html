<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="pragma" content="no-cache">
		<!-- 禁止浏览器从本地机的缓存中调阅页面内容 -->
		<meta http-equiv="cache-control" content="no-cache, must-revalidate">
		<meta http-equiv="expires" content="0">
		<title>谈判(中间页)</title>
		<link rel="stylesheet" href="../../../../media/js/bootstrap/css/bootstrap.css">
		<link rel="stylesheet" href="../../../../media/js/bootstrap/css/bootstrap-table.css">
		<style type="text/css">
			label {
				font-weight: normal;
			}
			
			
		</style>
	</head>
	<body>
		<table class="table table-bordered" style="width: 98%;margin-left: 7px;margin-top: 5px;">
	     		<tr class="active">
					<td colspan="4"><font size="3" color="black">项目信息</font></td>
				</tr>
				
				<tr>
					<td class="th_bg"  style="width: 20%;text-align: right;">竞卖项目名称<span id="ppName" class="text-danger"  style="font-weight:bold"></span></td>
					<td style="width: 30%;"><label id="projectName"></label></td>
					<td class="th_bg"  style="width: 20%;text-align: right;">竞卖项目编号</td>
					<td style="width: 30%;"><label id="projectCode"></label></td>
				</tr>
				<tr class="notNegotiation" style="display: none;">
					<td class="th_bg" style="width: 20%;text-align: right;">谈判方式</td>
					<td><span>不谈判</span></td>
					<td class="th_bg" style="width: 20%;text-align: right;">谈判最终报价(<span class="prieUnit"></span>)</td>
					<td><label id="lastPrice" ></label></td>
				</tr>
				
				
		</table>
		<div class='chooseNegotiator' style="display:none;width: 100%;height: 50px;text-align:center;position: fixed;bottom: 0;left:0;background-color: #FFFFFF;">
			<button onclick="chooseNegotiation()" type='button' class='btn btn-primary'><span class="glyphicon glyphicon glyphicon-pencil" aria-hidden="true"></span>选择谈判方式</button>
		</div>
	</body>
	<script type="text/javascript" src="../../../../media/js/jquery/jquery.js" ></script>
	 <script type="text/javascript" src="../../../../media/js/jquery/jquery.extend.js"></script>
	 <script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap.js" ></script>
	 <script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap-table.min.js" ></script>
	 <script type="text/javascript" src="../../../../media/js/bootstrap/js/bootstrap-table-zh-CN.min.js" ></script>
	 <script type="text/javascript" src="../../../../media/js/layer/layer.js" ></script>
	 <script type="text/javascript" src="../../../../media/js/base/common.js" ></script>
</html>

<script type="text/javascript">
	var findProjectNegotiatorInfo = parent.config.AuctionHost + "/NegotiationController/findProjectNegotiatorInfo.do";
	var searchUrl = parent.config.AuctionHost + "/NegotiationController/findNegotiationForDetialed.do";
	
	var projectId = getUrlParam("projectId");
	var packageId = getUrlParam("id");
	var createType = getUrlParam("createType") || 0;
	var tenderType = 2 //竞卖
	
	var negotiations = [];
	var detailsList = []; 
	var auctionPackageDetaileds = [];

	var itemState ="";//结果通知书发布状态
	
	var row;
	
	$(".prieUnit").html(top.prieUnit||"");
	
	$(function(){
		
		$.ajax({
			type: "post",
			url:findProjectNegotiatorInfo,
			datatype: 'json',
			data:{
				projectId:projectId,
				packageId:packageId,
				tenderType:tenderType,
			},
			async: true,
			success: function(data) {
				if(data.success) {
					row = data.data;
					//回显数据
					getMessage(row);
				
					//判断是否谈判
					if(row.negotiationState == '0') {
						//已谈判
						
						if(row.negotiationType == '0'){
							
							//线上谈判
							onLineNegotiation();
							
						}
						
						if(row.negotiationType == '1') {
							
							//线下谈判
							outLineNegotiation();
							
						}
								
						if(row.negotiationType == '2') { 
							//不谈判
							notNegotiation();
						}
							
					}else{
						//未谈判
						if(row.createType != "undefined" && row.createType == 1 ){//当前项目不为自己发布的项目时
							parent.layer.alert("温馨提示：当前项目还未进行谈判！");
						}else{
							//选择谈判方式
							//chooseNegotiation();
							$(".chooseNegotiator").show();
						}
					}
					
				}
			}
		});
	})
	
	
	//数据信息回显
	function getMessage(obj){
			
		$('label').each(function(){

			$(this).text(obj[this.id]);
		});
		
		if(obj.packageSource == '1') {
			$("#ppName").html("(重新竞卖)");
		} else {
			$("#ppName").html("");
		}
		
		if(obj.itemState != undefined && obj.itemState == 2){
			itemState = 2;
		}
	}
	
	//选择谈判方式
	function chooseNegotiation(){
		if(itemState == 2){
			parent.layer.alert("该阶段无法谈判");	
			return;
		}
		
		
		//谈判  选择是线上还是线下谈判还是不谈判
		parent.layer.open({
			type: 2,
			title: '选择谈判方式',
			area: ['650px', '225px'],
			maxmin: false, //该参数值对type:1和type:2有效。默认不显示最大小化按钮。需要显示配置maxmin: true即可
			resize: false, //是否允许拉伸
			content: 'Auction/Sale/Agent/SaleSupplierNegotiator/NegotiatorMethod.html?projectId='+projectId+'&id='+packageId,
			success: function(layero, index) {
				var body = layer.getChildFrame('body', index);
				var iframeWin = layero.find('iframe')[0].contentWindow;
				iframeWin.getMessage(row);
				parent.layer.close(parent.layer.getFrameIndex(window.name));
			}
		});
		
		
	}
	
	//线上谈判
	function onLineNegotiation(){
		//parent.layer.close(parent.layer.getFrameIndex(window.name));
		//查看
		parent.layer.open({
			type: 2 //此处以iframe举例
				,
			title: '价格谈判',
			area: ['1000px', '600px'],
			content: 'Auction/Sale/Agent/SaleSupplierNegotiator/pPriceNegotiator.html?'+"createType="+createType+'&projectId='+projectId+'&id='+packageId,
			id:'pPriceNego',
			success: function(layero, index) {
				var body = layer.getChildFrame('body', index);
				var iframeWin = layero.find('iframe')[0].contentWindow;
				iframeWin.tableShow(row);
				parent.layer.close(parent.layer.getFrameIndex(window.name));
			}
		});
		
	}
	
	//下线谈判
	function outLineNegotiation(){
		//parent.layer.close(parent.layer.getFrameIndex(window.name));
		//查看
		parent.layer.open({
			type: 2, //此处以iframe举例
			title: '价格谈判',
			area: ['80%', '85%'],
			id: "negotiators",
			content: 'Auction/Sale/Agent/SaleSupplierNegotiator/underline.html?projectId='+projectId+'&id='+packageId,
			success: function(layero, index) {
				var body = layer.getChildFrame('body', index);
				var iframeWin = layero.find('iframe')[0].contentWindow;
				iframeWin.getShow(row);
				parent.layer.close(parent.layer.getFrameIndex(window.name));
			}
		});
		
	}
	
	//不谈判
	function notNegotiation(){
		$(".notNegotiation").show();
	}
	
	function getUrlParam(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); // 构造一个含有目标参数的正则表达式对象  
		var r = window.location.search.substr(1).match(reg); // 匹配目标参数  
		if(r != null) return unescape(r[2]);
		return null; // 返回参数值  
	}
	
</script>
