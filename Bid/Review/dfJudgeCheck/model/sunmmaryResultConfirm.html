<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" type="text/css" href="../../../media/js/layer/mobile/need/layer.css" />
	<link rel="stylesheet" type="text/css" href="../../../media/js/layer/css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../../../media/js/bootstrap/css/bootstrap.css" />
	<!-- <link rel="stylesheet" type="text/css" href="../../../media/js/bootstrap/css/bootstrap-table.css"> -->
	<style>
		.layui-table th{
			font-weight: 600;
		}
	</style>
</head>

<body>
	<div style="margin-bottom: 60px;padding: 5px;">
		<table class="table table-bordered" id="mainTable"></table>
	</div>

	<div class="bottom-btn">
		<div class="row">
			<div class="col-md-4" style="text-align: left;">
				<div id="color_tips" style="display: none;">系统会对客观分进行判断，<span style="background:#e43636;color:white;padding: 5px;">红色</span>代表不一致，<span style="background:green;color:white;padding: 5px;">绿色</span>代表一致。</div>
			</div>
			<div class="col-md-3">
				<button type="button" class="btn btn-primary" id="btnBack">回退修改</button>
				<button type="button" class="btn btn-primary" id="btnGoOn" style="display: none;">继续评审</button>
				<button type="button" class="btn btn-primary" id="btnReason" style="display: none;">补充原因</button>
			</div>
			<div class="col-md-5" style="text-align: left;">
				<div>回退修改：所有评委统一回退修改打分及填写原因</div>
				<div>补充说明：所有评委只针对客观分不一致打分项填写原因，不可修改打分</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" src="../../../media/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../../../media/js/jquery/jquery.extend.js"></script>
<script type="text/javascript" src="../../../media/js/base/common.js"></script>
<script type="text/javascript" src="../../../media/js/layer/layer.js"></script>
<script type="text/javascript" src="../../../media/js/layer/layui.js"></script>
<script type="text/javascript" src="../../../media/js/base/util.js"></script>
<script type="text/javascript" src="../../../media/js/bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="../../../media/js/bootstrap/js/bootstrap-table.min.js"></script>
<script type="text/javascript" src="../../../media/js/bootstrap/js/bootstrap-table-zh-CN.min.js"></script>
<script>
	var bidSectionId = getUrlParam("bidSectionId");//标段Id
	var bidCheckId = getUrlParam("bidCheckId");//评标id
	var examType = getUrlParam("examType");
	var nodeSubType = getUrlParam("nodeSubType");
	var nodeType = getUrlParam("nodeType");
	var checkUrl = top.config.Reviewhost + '/ReviewControll/review.do';
	var checkType = '';//0合格制  1偏离制 2响应制 3打分制
	var checkData = [], colsData = [], bidCheckItems;
	var height = document.documentElement.clientHeight - 95;
	//关闭
	$("#btnClose").click(function () {
		var index = top.layer.getFrameIndex(window.name);
		top.layer.close(index);
	});
	$.ajax({
		type: "post",
		url: checkUrl,
		async: false,
		data: {
			'method': 'getExpertCheckSummary',
			'nodeType': nodeType,
			'bidSectionId': bidSectionId,
			'examType': examType,
			'nodeSubType': nodeSubType
		},
		success: function (res) {
			var colsData1 = [
				{title: '序号', type:'numbers', fixed: 'left', rowspan: '3'},
				{field:'checkName',  title: '评价内容', fixed: 'left',width:'300', rowspan: '3'},
				{field:'checkStandard',  title: '评审标准', fixed: 'left',width:'300', rowspan: '3'}
			], colsData2 = [],  colsData3 = [];//三维数组
			var colspan = '1';//投标人合并列数（评委数量）
			if (res.success) {
				if(res.data){
					checkType = res.data.bidCheck.checkType;
					if(checkType == 3){
						$('#color_tips').show();
						var scoreType = {field:'itemScoreType',  title: '打分类型', fixed: 'left',width:'100', rowspan: '3', templet: function(val){
								if(val.itemScoreType == 1){
									return '主观分';
								}else if(val.itemScoreType == 2){
									return '客观分';
								}else{
									return '';
								}
							}}
						colsData1.push(scoreType);
					}
					if(res.data.confirmButnStatus && res.data.confirmButnStatus == 1){
						$('#btnGoOn').show();
					}
					if(res.data.updateReasonButnStatus && res.data.updateReasonButnStatus == 1){
						$('#btnReason').show();
					}
					if(res.data.packageCheckList){
						checkName = res.data.packageCheckList.checkName;
						checkType = res.data.packageCheckList.checkType;
					}
					if(res.data.experts){
						colspan = res.data.experts.length*2;
					}
					if(res.data.supplierDtos){
						var suppliers = res.data.supplierDtos;//投标人
						var experts = res.data.experts;//评委
						var scoreList = res.data.expertCheckItems;//打分
						bidCheckItems = res.data.bidCheckItems;//评审内容
						//循环供应商
						for(var i = 0;i<suppliers.length;i++){
							//处理一维数组
							var obj = {title: suppliers[i].enterpriseName ,align:'center', colspan: colspan};
							colsData1.push(obj);
							//循环评委
							for(var e=0;e<experts.length;e++){
								let fId = suppliers[i].supplierId + '_' + experts[e].expertId;
								let reason = fId + '_' + 'reason';
								//处理二维数组
								let objExperts = {title: experts[e].expertName,width:'100',align:'center', colspan: '2'}
								//处理三维数组
								let objScore = {field: '', title: '结果',width:'100',align:'center', templet: function(val){
									if(val[fId].scoreTypeFlag == 1){
										return '<div style="background:#e43636;color:white">'+val[fId].result+'</div>'
									}else if(val[fId].scoreTypeFlag == 2){
										return '<div style="background:green;color:white">'+val[fId].result+'</div>'
									}else{
										return val[fId].result
									}
								}};
								let objReason = {field: reason, title: '原因',width:'100',align:'center'};
								colsData2.push(objExperts);
								colsData3.push(objScore);
								colsData3.push(objReason);
							}
						}
								
						// 循环评审内容
						for(var b=0;b<bidCheckItems.length;b++){
							//处理打分
							for(var s=0;s<scoreList.length;s++){
								if(bidCheckItems[b].id == scoreList[s].checkItemId){
									var fId = scoreList[s].supplierId + '_' + scoreList[s].expertId;
									var reason = fId + '_' + 'reason';
									var keys = '';
									if (checkType == 0) {
										keys = scoreList[s].isKey == 1?'合格':scoreList[s].isKey == 0?'不合格':'';
									};
									if (checkType == 1) {
										keys = scoreList[s].isKey == 1?'不偏离':scoreList[s].isKey == 0?'偏离':'';
									};
									if (checkType == 2) {
										keys = scoreList[s].isKey == 1?'响应':scoreList[s].isKey == 0?'不响应':'';
									};
									//scoreTypeFlag 标记  0为正常 1为标红  2为标绿
									// bidCheckItems[b][fId] = (checkType == 3 || checkType == 1)?scoreList[s].itemScore:keys;
									bidCheckItems[b][reason] = scoreList[s].reason?scoreList[s].reason:'';
									bidCheckItems[b][fId] = {
										'result': checkType == 3?scoreList[s].score:keys,
										'scoreTypeFlag': scoreList[s].scoreTypeFlag || '',
										// 'reason':scoreList[s].reason?scoreList[s].reason:''
									}
									
								}
							}
						}
					}
					colsData = [colsData1, colsData2, colsData3];
					tableHtml(colsData, bidCheckItems);
				}
				
				
			} else {
				top.layer.alert(res.message);
			}
		}
	});
	var checkData = [
		{'bidderName': '111', 'fileSubmitTime':'qq', 'signDate': 'ooo', 'signInDate': 'ppp'},
		{'bidderName': '222', 'fileSubmitTime':'aa', 'signDate': 'ddd', 'signInDate': 'fff'},
	];
	function tableHtml(cols, data){
		layui.use('table', function(){
			var table = layui.table;
			  
			var tableIns =  table.render({
				elem: '#mainTable'
				,limit: Number.MAX_VALUE // 数据表格默认全部显示
		//		    ,url:'/demo/table/user/'
		//		    ,width: 892
			,height: height
			,cols: cols
				// ,cols: [[
				// 	{title: '序号', type:'numbers', fixed: 'left', rowspan: '2'}
				// 	,{field:'bidderName',  title: '投标单位名', fixed: 'left',width:'300', rowspan: '2'}
				// 	,{title: '供应商1',align:'center', colspan:'2'}
				// 	,{title: '供应商2',align:'center', colspan:'2'}
				// 	// ,{field:'fileSubmitTime',  title: '投标',width:'300', rowspan: '2'}
				// ],[
				// 	{field:'signDate', title: '评委1',width:'200',align:'center'},
				// 	{field:'signInDate', title: '评委2',width:'200',align:'center'},
				// 	{field:'sign', title: '评委1',width:'200',align:'center'},
				// 	{field:'signIn', title: '评委2',width:'200',align:'center'}
				// ]]
			,data:data
			});
		  
		});
	};
	function passMessage(callback){
		$('#btnBack').click(function(){
			top.layer.prompt({title: '请输入回退原因', formType: 2}, function(text, index){
				selectResults('1', callback, text);
				top.layer.close(index);
			});
			
		});
		$('#btnGoOn').click(function(){
			selectResults('0', callback)
		});
		$('#btnReason').click(function(){
			selectResults('2', callback)
		});
	};
	function selectResults(sType, callback, remark){
		var data = {
			'method': 'saveExpertConfirm',
			'nodeType': nodeType,
			'bidSectionId': bidSectionId,
			'examType': examType,
			'nodeSubType': nodeSubType,
			'submitType': sType
		};
		if(remark){
			data.remark = remark;
		}
		//submitType 0确认 1回退 2客观分确认
		$.ajax({
			type: "post",
			url: checkUrl,
			async: false,
			data: data,
			success: function (res) {
				if (res.success) {
					if(callback){
						callback();
					};
					var index = top.layer.getFrameIndex(window.name);
					top.layer.close(index);
				}else{
					top.layer.alert(res.message)
				}
			}
		});
	}
	
</script>

</html>